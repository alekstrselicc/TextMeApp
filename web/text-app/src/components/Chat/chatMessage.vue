<template>
  <div class="contents">
    <div class="main_chat" id="chat_id">
      <!-- Chat log need date, location, text, image of the person -->
      <v-row class="justify-start message_main">
        <div
          v-for="(item, index) in test"
          :key="index"
          class="main_msg justify-start rows"
        >
          <v-row>
            <div class="showing_name">{{ item.name }}</div>
          </v-row>
          <v-row>
            <div class="image_user">
              <v-avatar><v-img :src="item.img"></v-img></v-avatar>
            </div>

            <div class="msg_user">
              {{ item.message }}
              <!--<v-img :src="item.avatar"></v-img> -->
            </div>
          </v-row>
        </div>
      </v-row>
    </div>
    <div class="main_send">
      <ChatBar />
      <div class="main_box">
        <v-text-field
          class="search-input"
          solo
          hide-details
          rounded
          elevation-12
          placeholder="Message..."
          aria-label="Search"
          append-icon="mdi-arrow-right"
          @click:append="sendMessage()"
          v-model="message"
        ></v-text-field>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import Vue from "vue";
import ChatBar from "@/components/Chat/chatBar.vue";
import axios from "axios";
import Echo from "laravel-echo";

export default Vue.extend({
  name: "chatMessage",
  components: { ChatBar },
  data() {
    return {
      message: "",
      messages: [],
      user_name: "",
      test: [],
      tmp: { img: null, name: null, message: null },
    };
  },
  methods: {
    filterData(data, users) {
      //console.log(data);
      for (let i = 0; i < data.length; i++) {
        this.tmp = { img: null, name: null, message: null };
        for (let j = 0; j < users.length; j++) {
          if (users[j].id == data[i].user_id) {
            this.tmp = {
              img: users[j].img,
              name: users[j].first_name,
              message: data[i].messages,
            };
            this.test.push(this.tmp);
            break;
          }
        }
      }
    },

    sendMessage() {
      axios.post("http://127.0.0.1:8000/api/sendMessages", {
        messages: this.message,
        channel_id: this.$route.params.id,
        created_at: "2002-02-02 13:13:13",
        user_id: Vue.prototype.$userId,
      });

      this.message = "";
    },
    fetchMessages() {
      axios
        .get("http://127.0.0.1:8000/api/fetchMessage/" + this.$route.params.id)
        .then(async (res) => {
          //here is all the data
          await axios
            .get("http://127.0.0.1:8000/api/getAll")
            .then((response) => {
              this.filterData(res.data, response.data);
            });
          //this.messages = res.data;
          //console.log(this.messages[0].user_id);
          //await axios.get("http://127.0.0.1:8000/api/user/")
        });
    },
  },
  created() {
    axios.get("http://127.0.0.1:8000/api/user").then((res) => {
      this.user_name = res.data.first_name;
    });

    this.fetchMessages();

    window.Echo.channel("chat").listen("MessageSent", (e) => {
      //console.log("ti si pac delavec");
      console.log(e.channel_id + " == " + this.$route.params.id);
      if (e.channel_id == this.$route.params.id) {
        console.log("no kr dej notr ");
        this.test.push({
          message: e.messages,
        });
      }
    });
  },
});
</script>

<style>
.contents {
  width: 100% !important;
}
.main_send {
  width: 98% !important;
  height: 100px;
  position: absolute;
  bottom: 0;
}

.main_send .main_box .v-text-field.v-text-field--solo .v-input__control {
  min-height: 50px !important;
}

.main_box .v-input__icon--append .v-icon {
  color: white !important;
  font-size: 30px !important;
  border-radius: 50%;
  min-width: 46px !important;
  height: 45px !important;
  margin-left: 15px;
  background-color: #007abe !important;
}
.main_layout_buttons {
  width: 150px;
  height: 40px !important;
  margin-left: 5px;
}

@media (max-width: 960px) {
  .main_layout_buttons {
    width: 150px;
    height: 40px !important;
    margin-left: 5px;
  }
  .main_send {
    margin-bottom: 60px;
    width: 95% !important;
  }
}

.main_chat {
  width: 100% !important;
  height: calc(100vh - 340px) !important;
  max-height: 900px;
  overflow-y: scroll;
  overflow-x: hidden;
  margin-top: 50px;
}
.showing_name {
  color: white;
  margin-left: 70px;
}
.main_msg {
  margin-left: 30px;
  margin-top: 20px;
}
.rows,
.message_main {
  display: table;
  padding-bottom: 5px;
}
.image_user {
  display: table-cell;
  padding-right: 10px;
}
.msg_user {
  display: table-cell;
  max-width: 80%;
  font-size: 18px;
  padding: 7px;
  padding-bottom: -5px !important;
  border: 1px solid white;
  background: white;
  border-radius: 20px;
}

/* custom scroll bar */
::-webkit-scrollbar {
  background: transparent;
}

/* This is about message */

@media (max-width: 960px) {
  .main_chat {
    margin-bottom: 100px;
  }
}
</style>
